<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>GRH - Gestion des m√©decins</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #f4f5fb;
      color: #111827;
    }

    header {
      background: #0f766e;
      color: #ecfdf5;
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(15, 118, 110, 0.35);
    }

    header .logo {
      font-size: 1.2rem;
      font-weight: 650;
    }

    header nav a {
      color: #ecfdf5;
      text-decoration: none;
      margin-left: 14px;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    header nav a:hover {
      text-decoration: underline;
      opacity: 1;
    }

    main {
      max-width: 1100px;
      margin: 24px auto 40px auto;
      padding: 0 16px;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 12px;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.8fr);
      gap: 18px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 16px 14px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
      border: 1px solid #e5e7eb;
      margin-bottom: 14px;
    }

    .card h2 {
      font-size: 1.1rem;
      margin-bottom: 8px;
    }

    .card small {
      color: #6b7280;
      font-size: 0.8rem;
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #374151;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    select {
      width: 100%;
      padding: 7px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      margin-bottom: 10px;
      background: #f9fafb;
    }

    input:focus,
    select:focus {
      outline: 2px solid #0f766e;
      outline-offset: 1px;
      background: #ffffff;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 700px) {
      .row {
        grid-template-columns: 1fr;
      }
    }

    .btn {
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background-color 0.1s ease;
    }

    .btn-primary {
      background: #0f766e;
      color: #ecfdf5;
      font-weight: 600;
      box-shadow: 0 3px 8px rgba(15, 118, 110, 0.35);
    }

    .btn-primary:hover {
      background: #115e59;
      transform: translateY(-1px);
      box-shadow: 0 5px 12px rgba(15, 118, 110, 0.45);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn-danger {
      background: #b91c1c;
      color: white;
    }

    .btn-danger:hover {
      background: #991b1b;
    }

    .btn-sm {
      padding: 4px 10px;
      font-size: 0.8rem;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .message {
      margin-top: 8px;
      font-size: 0.85rem;
      padding: 8px 10px;
      border-radius: 8px;
      display: none;
    }

    .message.error {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .message.success {
      background: #ecfdf5;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.85rem;
    }

    thead {
      background: #f3f4f6;
    }

    th,
    td {
      padding: 8px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }

    tr:hover {
      background: #f9fafb;
    }

    .badge-spec {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .slots-list {
      font-size: 0.78rem;
      line-height: 1.4;
      max-height: 120px;
      overflow-y: auto;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-end;
      margin-top: 4px;
    }

    .filter-row > div {
      min-width: 160px;
      flex: 1;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 0.78rem;
      margin: 2px;
    }

    .chip button {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.8rem;
      padding: 0;
      line-height: 1;
    }

    .slots-container {
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      background: #f9fafb;
      max-height: 140px;
      overflow-y: auto;
      margin-top: 6px;
    }
  </style>
</head>
<body>
<header>
  <div class="logo">GRH ‚Äì M√©decins</div>
  <nav>
    <a href="index.html">Accueil</a>
    <a href="patients.html">Patients</a>
    <a href="doctors.html">M√©decins</a>
    <a href="appointments.html">Rendez-vous</a>
    <a href="reports.html">Rapports</a>
  </nav>
</header>

<main>
  <h1>Gestion des m√©decins</h1>

  <div class="layout">
    <!-- Colonne gauche : Formulaire m√©decin + WorkSlots -->
    <section>
      <div class="card">
        <h2>Nouveau / Modifier un m√©decin</h2>
        <small>D√©finissez l‚Äôidentit√© du m√©decin, sa sp√©cialit√© et ses cr√©neaux de travail (WorkSlots).</small>

        <form id="doctorForm" style="margin-top: 10px;">
          <input type="hidden" id="doctorId" />

          <label for="fullNameInput">Nom complet</label>
          <input type="text" id="fullNameInput" required />

          <label for="specialtyInput">Sp√©cialit√©</label>
          <input type="text" id="specialtyInput" placeholder="Cardiologie, Neurologie, ..." required />

          <div class="row">
            <div>
              <label for="phoneInput">T√©l√©phone</label>
              <input type="tel" id="phoneInput" placeholder="+2126..." />
            </div>
            <div>
              <label for="emailInput">Email</label>
              <input type="email" id="emailInput" placeholder="medecin@example.com" />
            </div>
          </div>

          <hr style="margin: 8px 0 10px 0; border: none; border-top: 1px dashed #e5e7eb;" />

          <h3 style="font-size: 0.95rem; margin-bottom: 6px;">Cr√©neaux de travail (WorkSlots)</h3>
          <small>Jour de la semaine + heure de d√©but et de fin. Ces cr√©neaux sont utilis√©s pour v√©rifier la disponibilit√© et calculer les rendez-vous possibles.</small>

          <div class="row" style="margin-top: 8px;">
            <div>
              <label for="weekdaySelect">Jour</label>
              <select id="weekdaySelect">
                <option value="1">Lundi</option>
                <option value="2">Mardi</option>
                <option value="3">Mercredi</option>
                <option value="4">Jeudi</option>
                <option value="5">Vendredi</option>
                <option value="6">Samedi</option>
                <option value="7">Dimanche</option>
              </select>
            </div>
            <div>
              <label for="slotStartInput">D√©but</label>
              <input type="time" id="slotStartInput" />
            </div>
            <div>
              <label for="slotEndInput">Fin</label>
              <input type="time" id="slotEndInput" />
            </div>
          </div>

          <button type="button" class="btn btn-secondary btn-sm" id="addSlotBtn" style="margin-top: 4px;">
            ‚ûï Ajouter ce cr√©neau
          </button>

          <div class="slots-container" id="currentSlotsContainer">
            <small>Aucun cr√©neau d√©fini pour l‚Äôinstant.</small>
          </div>

          <div class="actions" style="margin-top: 10px;">
            <button type="submit" class="btn btn-primary" id="submitBtn">
              üíæ Enregistrer le m√©decin
            </button>
            <button type="button" class="btn btn-secondary" id="resetBtn">
              ‚Ü∫ R√©initialiser
            </button>
          </div>

          <div id="formMessage" class="message"></div>
        </form>
      </div>
    </section>

    <!-- Colonne droite : Liste des m√©decins + filtres -->
    <section>
      <div class="card">
        <h2>Liste des m√©decins</h2>
        <small>Recherchez par nom ou filtrez par sp√©cialit√©. Vous pouvez modifier ou supprimer un m√©decin.</small>

        <div class="filter-row">
          <div>
            <label for="searchNameInput">Recherche par nom</label>
            <input type="text" id="searchNameInput" placeholder="Nom du m√©decin..." />
          </div>
          <div>
            <label for="filterSpecialtySelect">Filtre sp√©cialit√©</label>
            <select id="filterSpecialtySelect">
              <option value="">Toutes les sp√©cialit√©s</option>
            </select>
          </div>
        </div>

        <div id="listMessage" class="message" style="margin-top: 8px;"></div>

        <table>
          <thead>
          <tr>
            <th>Nom</th>
            <th>Sp√©cialit√©</th>
            <th>Contact</th>
            <th>WorkSlots</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody id="doctorsTableBody">
          <!-- rempli en JS -->
          </tbody>
        </table>
      </div>
    </section>
  </div>
</main>

<script>
  const API_BASE = "http://localhost:8081";

  const doctorForm = document.getElementById("doctorForm");
  const doctorIdInput = document.getElementById("doctorId");
  const fullNameInput = document.getElementById("fullNameInput");
  const specialtyInput = document.getElementById("specialtyInput");
  const phoneInput = document.getElementById("phoneInput");
  const emailInput = document.getElementById("emailInput");

  const weekdaySelect = document.getElementById("weekdaySelect");
  const slotStartInput = document.getElementById("slotStartInput");
  const slotEndInput = document.getElementById("slotEndInput");
  const addSlotBtn = document.getElementById("addSlotBtn");
  const currentSlotsContainer = document.getElementById("currentSlotsContainer");

  const submitBtn = document.getElementById("submitBtn");
  const resetBtn = document.getElementById("resetBtn");
  const formMessage = document.getElementById("formMessage");

  const searchNameInput = document.getElementById("searchNameInput");
  const filterSpecialtySelect = document.getElementById("filterSpecialtySelect");
  const listMessage = document.getElementById("listMessage");
  const doctorsTableBody = document.getElementById("doctorsTableBody");

  let currentSlots = [];   // tableau de workSlots pour le m√©decin en cours d‚Äô√©dition
  let allDoctors = [];     // cache des m√©decins pour filtrage

  function showMessage(el, text, type) {
    el.textContent = text;
    el.classList.remove("error", "success");
    if (!text) {
      el.style.display = "none";
      return;
    }
    el.classList.add(type === "error" ? "error" : "success");
    el.style.display = "block";
  }

  function weekdayLabel(num) {
    const map = {
      1: "Lundi",
      2: "Mardi",
      3: "Mercredi",
      4: "Jeudi",
      5: "Vendredi",
      6: "Samedi",
      7: "Dimanche"
    };
    return map[num] || ("Jour " + num);
  }

  function renderCurrentSlots() {
    currentSlotsContainer.innerHTML = "";
    if (!currentSlots.length) {
      currentSlotsContainer.innerHTML = "<small>Aucun cr√©neau d√©fini pour l‚Äôinstant.</small>";
      return;
    }
    currentSlots.forEach((s, index) => {
      const chip = document.createElement("div");
      chip.className = "chip";
      const start = s.startTime || s.start || "";
      const end = s.endTime || s.end || "";
      chip.innerHTML = `
        <span>${weekdayLabel(s.weekday)} ${start} ‚Üí ${end}</span>
      `;
      const btn = document.createElement("button");
      btn.textContent = "√ó";
      btn.title = "Supprimer ce cr√©neau";
      btn.onclick = () => {
        currentSlots.splice(index, 1);
        renderCurrentSlots();
      };
      chip.appendChild(btn);
      currentSlotsContainer.appendChild(chip);
    });
  }

  addSlotBtn.addEventListener("click", () => {
    const weekday = parseInt(weekdaySelect.value, 10);
    const start = slotStartInput.value;
    const end = slotEndInput.value;

    if (!start || !end) {
      alert("Veuillez saisir l‚Äôheure de d√©but et de fin.");
      return;
    }
    if (end <= start) {
      alert("L‚Äôheure de fin doit √™tre sup√©rieure √† l‚Äôheure de d√©but.");
      return;
    }

    // IMPORTANT : adapter les cl√©s (startTime/endTime) √† ton WorkSlotDto si besoin
    currentSlots.push({
      weekday: weekday,
      startTime: start,
      endTime: end
    });

    slotStartInput.value = "";
    slotEndInput.value = "";
    renderCurrentSlots();
  });

  function resetForm() {
    doctorForm.reset();
    doctorIdInput.value = "";
    currentSlots = [];
    renderCurrentSlots();
    submitBtn.textContent = "üíæ Enregistrer le m√©decin";
    showMessage(formMessage, "", "success");
  }

  resetBtn.addEventListener("click", (e) => {
    e.preventDefault();
    resetForm();
  });

  // CRUD : chargement des m√©decins
  async function loadDoctors() {
    try {
      showMessage(listMessage, "Chargement des m√©decins‚Ä¶", "success");
      const res = await fetch(API_BASE + "/doctors");
      if (!res.ok) {
        showMessage(listMessage, "Impossible de charger les m√©decins.", "error");
        return;
      }
      const data = await res.json();
      allDoctors = data;
      populateSpecialtyFilter(data);
      renderDoctors();
      showMessage(listMessage, "", "success");
    } catch (e) {
      console.error(e);
      showMessage(listMessage, "Erreur r√©seau lors du chargement des m√©decins.", "error");
    }
  }

  function populateSpecialtyFilter(doctors) {
    const set = new Set();
    doctors.forEach(d => {
      if (d.specialty) set.add(d.specialty);
    });
    filterSpecialtySelect.innerHTML = '<option value="">Toutes les sp√©cialit√©s</option>';
    Array.from(set).sort().forEach(spec => {
      const opt = document.createElement("option");
      opt.value = spec;
      opt.textContent = spec;
      filterSpecialtySelect.appendChild(opt);
    });
  }

  function renderDoctors() {
    const nameFilter = (searchNameInput.value || "").toLowerCase();
    const specFilter = filterSpecialtySelect.value;

    doctorsTableBody.innerHTML = "";

    const filtered = allDoctors.filter(d => {
      const nameMatch = !nameFilter ||
        (d.fullName && d.fullName.toLowerCase().includes(nameFilter));
      const specMatch = !specFilter ||
        (d.specialty && d.specialty === specFilter);
      return nameMatch && specMatch;
    });

    if (!filtered.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.textContent = "Aucun m√©decin ne correspond aux crit√®res.";
      tr.appendChild(td);
      doctorsTableBody.appendChild(tr);
      return;
    }

    filtered.forEach(d => {
      const tr = document.createElement("tr");

      const contactText = [
        d.phone ? "üìû " + d.phone : "",
        d.email ? "‚úâÔ∏è " + d.email : ""
      ].filter(Boolean).join("<br>");

      const specBadge = d.specialty
        ? `<span class="badge-spec">${d.specialty}</span>`
        : "‚Äî";

      const slotsHtml = renderSlotsList(d.workSlots || []);

      tr.innerHTML = `
        <td>${d.fullName || "‚Äî"}</td>
        <td>${specBadge}</td>
        <td>${contactText || "‚Äî"}</td>
        <td>${slotsHtml}</td>
        <td></td>
      `;

      const actionsTd = tr.lastElementChild;

      const editBtn = document.createElement("button");
      editBtn.className = "btn btn-secondary btn-sm";
      editBtn.textContent = "Modifier";
      editBtn.onclick = () => fillFormForEdit(d);

      const deleteBtn = document.createElement("button");
      deleteBtn.className = "btn btn-danger btn-sm";
      deleteBtn.textContent = "Supprimer";
      deleteBtn.onclick = () => deleteDoctor(d.id);

      actionsTd.appendChild(editBtn);
      actionsTd.appendChild(deleteBtn);

      doctorsTableBody.appendChild(tr);
    });
  }

  function renderSlotsList(slots) {
    if (!slots || !slots.length) return '<div class="slots-list"><em>Aucun cr√©neau</em></div>';
    let html = '<div class="slots-list">';
    slots.forEach(s => {
      const start = s.startTime || s.start || "";
      const end = s.endTime || s.end || "";
      html += `<div>${weekdayLabel(s.weekday)} ${start} ‚Üí ${end}</div>`;
    });
    html += "</div>";
    return html;
  }

  function fillFormForEdit(d) {
    doctorIdInput.value = d.id;
    fullNameInput.value = d.fullName || "";
    specialtyInput.value = d.specialty || "";
    phoneInput.value = d.phone || (d.contact && d.contact.phone) || "";
    emailInput.value = d.email || (d.contact && d.contact.email) || "";

    currentSlots = (d.workSlots || []).map(s => ({
      weekday: s.weekday,
      startTime: s.startTime || s.start,
      endTime: s.endTime || s.end
    }));
    renderCurrentSlots();

    submitBtn.textContent = "‚úèÔ∏è Mettre √† jour le m√©decin";
    showMessage(formMessage, "Mode √©dition : vous modifiez un m√©decin existant.", "success");
  }

  async function deleteDoctor(id) {
    if (!confirm("Supprimer ce m√©decin ? Les rendez-vous associ√©s peuvent √™tre impact√©s.")) return;
    try {
      const res = await fetch(API_BASE + "/doctors/" + id, {
        method: "DELETE"
      });
      if (!res.ok) {
        let msg = "Impossible de supprimer ce m√©decin.";
        try {
          const err = await res.json();
          if (err && err.message) msg = err.message;
        } catch {}
        alert(msg);
        return;
      }
      await loadDoctors();
    } catch (e) {
      console.error(e);
      alert("Erreur r√©seau lors de la suppression du m√©decin.");
    }
  }

  doctorForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = doctorIdInput.value;

    if (!fullNameInput.value || !specialtyInput.value) {
      showMessage(formMessage, "Nom et sp√©cialit√© sont obligatoires.", "error");
      return;
    }

    // IMPORTANT : adapter la structure au DoctorRequest de ton backend si besoin
    const body = {
      fullName: fullNameInput.value,
      specialty: specialtyInput.value,
      phone: phoneInput.value || null,
      email: emailInput.value || null,
      workSlots: currentSlots
    };

    const url = id ? (API_BASE + "/doctors/" + id) : (API_BASE + "/doctors");
    const method = id ? "PUT" : "POST";

    try {
      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        let msg = "Erreur lors de l‚Äôenregistrement du m√©decin.";
        try {
          const err = await res.json();
          if (err && err.message) msg = err.message;
        } catch {}
        showMessage(formMessage, msg, "error");
        return;
      }

      showMessage(
        formMessage,
        id ? "M√©decin mis √† jour avec succ√®s." : "M√©decin cr√©√© avec succ√®s.",
        "success"
      );
      resetForm();
      await loadDoctors();
    } catch (e2) {
      console.error(e2);
      showMessage(formMessage, "Erreur r√©seau lors de l‚Äôenregistrement.", "error");
    }
  });

  searchNameInput.addEventListener("input", () => renderDoctors());
  filterSpecialtySelect.addEventListener("change", () => renderDoctors());

  // Initialisation
  (function init() {
    loadDoctors();
  })();
</script>
</body>
</html>
