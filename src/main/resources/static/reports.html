<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>GRH - Rapports & statistiques</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #f4f5fb;
      color: #111827;
    }

    header {
      background: #0f766e;
      color: #ecfdf5;
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(15, 118, 110, 0.35);
    }

    header .logo {
      font-size: 1.2rem;
      font-weight: 650;
    }

    header nav a {
      color: #ecfdf5;
      text-decoration: none;
      margin-left: 14px;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    header nav a:hover {
      text-decoration: underline;
      opacity: 1;
    }

    main {
      max-width: 1200px;
      margin: 24px auto 40px auto;
      padding: 0 16px;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 12px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 18px;
      margin-top: 10px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 16px 14px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
      border: 1px solid #e5e7eb;
      margin-bottom: 14px;
    }

    .card h2 {
      font-size: 1.1rem;
      margin-bottom: 4px;
    }

    .card small {
      color: #6b7280;
      font-size: 0.8rem;
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #374151;
    }

    input[type="date"],
    input[type="number"] {
      width: 100%;
      padding: 7px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      margin-bottom: 6px;
      background: #f9fafb;
    }

    input:focus {
      outline: 2px solid #0f766e;
      outline-offset: 1px;
      background: #ffffff;
    }

    .btn {
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background-color 0.1s ease;
    }

    .btn-primary {
      background: #0f766e;
      color: #ecfdf5;
      font-weight: 600;
      box-shadow: 0 3px 8px rgba(15, 118, 110, 0.35);
    }

    .btn-primary:hover {
      background: #115e59;
      transform: translateY(-1px);
      box-shadow: 0 5px 12px rgba(15, 118, 110, 0.45);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn-sm {
      padding: 4px 10px;
      font-size: 0.8rem;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .message {
      margin-top: 8px;
      font-size: 0.85rem;
      padding: 8px 10px;
      border-radius: 8px;
      display: none;
    }

    .message.error {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .message.success {
      background: #ecfdf5;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.85rem;
    }

    thead {
      background: #f3f4f6;
    }

    th,
    td {
      padding: 8px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }

    tr:hover {
      background: #f9fafb;
    }

    .muted {
      color: #6b7280;
      font-size: 0.8rem;
    }

    .badge-status {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-status-scheduled {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .badge-status-cancelled {
      background: #fee2e2;
      color: #b91c1c;
    }

    .badge-status-terminated {
      background: #e5e7eb;
      color: #374151;
    }

    .row-inline {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      gap: 8px;
      margin-top: 6px;
    }

    .row-inline > div {
      min-width: 140px;
      flex: 0 0 auto;
    }
  </style>
</head>
<body>
<header>
  <div class="logo">GRH â€“ Rapports</div>
  <nav>
    <a href="index.html">Accueil</a>
    <a href="patients.html">Patients</a>
    <a href="doctors.html">MÃ©decins</a>
    <a href="appointments.html">Rendez-vous</a>
    <a href="reports.html">Rapports</a>
  </nav>
</header>

<main>
  <h1>Rapports & statistiques</h1>

  <div class="grid">
    <!-- Bloc 1 : Rendez-vous d'une journÃ©e -->
    <section class="card">
      <h2>Rendez-vous dâ€™une journÃ©e</h2>
      <small>Liste des rendez-vous pour une date donnÃ©e, avec patient, mÃ©decin, heure et statut.</small>

      <div class="row-inline">
        <div>
          <label for="dayDateInput">Date</label>
          <input type="date" id="dayDateInput" />
        </div>
        <div>
          <button class="btn btn-primary btn-sm" id="loadDayBtn">Charger</button>
        </div>
      </div>

      <div id="dayMessage" class="message"></div>

      <table>
        <thead>
        <tr>
          <th>Patient</th>
          <th>MÃ©decin</th>
          <th>Heure</th>
          <th>DurÃ©e</th>
          <th>Statut</th>
        </tr>
        </thead>
        <tbody id="dayTableBody">
        <!-- rempli en JS -->
        </tbody>
      </table>
    </section>

    <!-- Bloc 2 : RDV par mÃ©decin -->
    <section class="card">
      <h2>Nombre de rendez-vous par mÃ©decin</h2>
      <small>Vue globale du volume de rendez-vous pour chaque mÃ©decin.</small>

      <div class="actions" style="margin-top: 8px;">
        <button class="btn btn-secondary btn-sm" id="loadPerDoctorBtn">
          ðŸ”„ Actualiser
        </button>
      </div>

      <div id="perDoctorMessage" class="message"></div>

      <table>
        <thead>
        <tr>
          <th>MÃ©decin</th>
          <th>Nombre de rendez-vous</th>
        </tr>
        </thead>
        <tbody id="perDoctorTableBody">
        <!-- rempli en JS -->
        </tbody>
      </table>
    </section>

    <!-- Bloc 3 : RDV par spÃ©cialitÃ© -->
    <section class="card">
      <h2>Nombre de rendez-vous par spÃ©cialitÃ©</h2>
      <small>Regroupe les rendez-vous selon la spÃ©cialitÃ© des mÃ©decins.</small>

      <div class="actions" style="margin-top: 8px;">
        <button class="btn btn-secondary btn-sm" id="loadPerSpecialtyBtn">
          ðŸ”„ Actualiser
        </button>
      </div>

      <div id="perSpecialtyMessage" class="message"></div>

      <table>
        <thead>
        <tr>
          <th>SpÃ©cialitÃ©</th>
          <th>Nombre de rendez-vous</th>
        </tr>
        </thead>
        <tbody id="perSpecialtyTableBody">
        <!-- rempli en JS -->
        </tbody>
      </table>
    </section>

    <!-- Bloc 4 : Patients frÃ©quents -->
    <section class="card">
      <h2>Patients frÃ©quents</h2>
      <small>Patients ayant eu plusieurs rendez-vous sur une pÃ©riode donnÃ©e.</small>

      <div class="row-inline">
        <div>
          <label for="daysInput">PÃ©riode (jours)</label>
          <input type="number" id="daysInput" min="1" value="60" />
        </div>
        <div>
          <button class="btn btn-primary btn-sm" id="loadFrequentBtn">
            Charger
          </button>
        </div>
      </div>

      <div id="frequentMessage" class="message"></div>

      <table>
        <thead>
        <tr>
          <th>Patient</th>
          <th>Nombre de visites</th>
        </tr>
        </thead>
        <tbody id="frequentTableBody">
        <!-- rempli en JS -->
        </tbody>
      </table>
    </section>
  </div>
</main>

<script>
  const API_BASE = "http://localhost:8081";
  let patientsById = {};
  let doctorsById = {};
  const dayDateInput = document.getElementById("dayDateInput");
  const dayTableBody = document.getElementById("dayTableBody");
  const dayMessage = document.getElementById("dayMessage");
  const loadDayBtn = document.getElementById("loadDayBtn");

  const perDoctorTableBody = document.getElementById("perDoctorTableBody");
  const perDoctorMessage = document.getElementById("perDoctorMessage");
  const loadPerDoctorBtn = document.getElementById("loadPerDoctorBtn");

  const perSpecialtyTableBody = document.getElementById("perSpecialtyTableBody");
  const perSpecialtyMessage = document.getElementById("perSpecialtyMessage");
  const loadPerSpecialtyBtn = document.getElementById("loadPerSpecialtyBtn");

  const daysInput = document.getElementById("daysInput");
  const frequentTableBody = document.getElementById("frequentTableBody");
  const frequentMessage = document.getElementById("frequentMessage");
  const loadFrequentBtn = document.getElementById("loadFrequentBtn");

  function showMessage(el, text, type) {
    el.textContent = text;
    el.classList.remove("error", "success");
    if (!text) {
      el.style.display = "none";
      return;
    }
    el.classList.add(type === "error" ? "error" : "success");
    el.style.display = "block";
  }

  async function loadPatients() {
    try {
      const res = await fetch(API_BASE + "/patients");
      if (!res.ok) return;
      const data = await res.json();

      patientsById = {};
      data.forEach(p => {
        if (p.id) {
          patientsById[p.id] = p;
        }
      });
    } catch (e) {
      console.warn("Erreur chargement patients", e);
    }
  }

  async function loadDoctors() {
    try {
      const res = await fetch(API_BASE + "/doctors");
      if (!res.ok) return;
      const data = await res.json();

      doctorsById = {};
      data.forEach(d => {
        if (d.id) {
          doctorsById[d.id] = d;
        }
      });
    } catch (e) {
      console.warn("Erreur chargement mÃ©decins", e);
    }
  }

  function isoToday() {
    return new Date().toISOString().slice(0, 10);
  }

  function renderStatusBadge(status) {
    if (!status) return "";
    const s = status.toUpperCase();
    let cls = "badge-status";
    if (s === "SCHEDULED") cls += " badge-status-scheduled";
    else if (s === "CANCELLED") cls += " badge-status-cancelled";
    else if (s === "TERMINATED") cls += " badge-status-terminated";
    return `<span class="${cls}">${status}</span>`;
  }

  // --- Bloc 1: RDV d'une journÃ©e ---
  async function loadDayAppointments() {
    const date = dayDateInput.value || isoToday();
    try {
      showMessage(dayMessage, "Chargement des rendez-vousâ€¦", "success");
      const res = await fetch(API_BASE + "/reports/day?date=" + date);
      if (!res.ok) {
        showMessage(dayMessage, "Impossible de charger les rendez-vous du jour.", "error");
        return;
      }
      const data = await res.json();
      renderDayTable(data);
      showMessage(dayMessage, "", "success");
    } catch (e) {
      console.error(e);
      showMessage(dayMessage, "Erreur rÃ©seau lors du chargement.", "error");
    }
  }

  function renderDayTable(appointments) {
    dayTableBody.innerHTML = "";
    if (!appointments || !appointments.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.textContent = "Aucun rendez-vous pour cette date.";
      tr.appendChild(td);
      dayTableBody.appendChild(tr);
      return;
    }
    appointments.forEach(a => {
      const tr = document.createElement("tr");
      const patient = a.patientId ? patientsById[a.patientId] : null;
      const doctor  = a.doctorId ? doctorsById[a.doctorId] : null;
      const patientName =
        a.patientName ||
        (patient && patient.fullName) ||
        a.patientId ||
        "â€”";

      const doctorName =
        a.doctorName ||
        (doctor && doctor.fullName) ||
        a.doctorId ||
        "â€”";
      const time = a.time || "â€”";
      const duration = a.durationMinutes != null ? a.durationMinutes + " min" : "â€”";
      const statusCell = renderStatusBadge(a.status || "");

      tr.innerHTML = `
        <td>${patientName}</td>
        <td>${doctorName}</td>
        <td>${time}</td>
        <td>${duration}</td>
        <td>${statusCell}</td>
      `;
      dayTableBody.appendChild(tr);
    });
  }

  // --- Bloc 2: RDV par mÃ©decin ---
  async function loadAppointmentsPerDoctor() {
    try {
      showMessage(perDoctorMessage, "Chargementâ€¦", "success");
      const res = await fetch(API_BASE + "/reports/appointments-per-doctor");
      if (!res.ok) {
        showMessage(perDoctorMessage, "Erreur lors du chargement des statistiques par mÃ©decin.", "error");
        return;
      }
      const data = await res.json();
      renderPerDoctorTable(data);
      showMessage(perDoctorMessage, "", "success");
    } catch (e) {
      console.error(e);
      showMessage(perDoctorMessage, "Erreur rÃ©seau lors du chargement.", "error");
    }
  }

  function renderPerDoctorTable(stats) {
    perDoctorTableBody.innerHTML = "";
    if (!stats || !stats.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 2;
      td.textContent = "Aucune donnÃ©e.";
      tr.appendChild(td);
      perDoctorTableBody.appendChild(tr);
      return;
    }
    stats.forEach(s => {
      const doc = s.doctorId ? doctorsById[s.doctorId] : null;
      const name =
        s.doctorName ||
        s.name ||
        (doc && doc.fullName) ||
        s.doctorId ||
        "â€”";
      const count = s.count != null ? s.count : (s.total != null ? s.total : (s.appointmentCount != null ? s.appointmentCount : "â€”"));
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${name}</td>
        <td>${count}</td>
      `;
      perDoctorTableBody.appendChild(tr);
    });
  }

  // --- Bloc 3: RDV par spÃ©cialitÃ© ---
  async function loadAppointmentsPerSpecialty() {
    try {
      showMessage(perSpecialtyMessage, "Chargementâ€¦", "success");
      const res = await fetch(API_BASE + "/reports/appointments-per-specialty");
      if (!res.ok) {
        showMessage(perSpecialtyMessage, "Erreur lors du chargement des statistiques par spÃ©cialitÃ©.", "error");
        return;
      }
      const data = await res.json();
      renderPerSpecialtyTable(data);
      showMessage(perSpecialtyMessage, "", "success");
    } catch (e) {
      console.error(e);
      showMessage(perSpecialtyMessage, "Erreur rÃ©seau lors du chargement.", "error");
    }
  }

  function renderPerSpecialtyTable(stats) {
    perSpecialtyTableBody.innerHTML = "";
    if (!stats || !stats.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 2;
      td.textContent = "Aucune donnÃ©e.";
      tr.appendChild(td);
      perSpecialtyTableBody.appendChild(tr);
      return;
    }
    
    stats.forEach(s => {
      const spec = s.specialty || s.speciality || s.name || "â€”";
      const count = s.count != null ? s.count :
              (s.total != null ? s.total :
              (s.appointmentCount != null ? s.appointmentCount : "â€”"));
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${spec}</td>
        <td>${count}</td>
      `;
      perSpecialtyTableBody.appendChild(tr);
    });
  }

  // --- Bloc 4: Patients frÃ©quents ---
  async function loadFrequentPatients() {
    const days = parseInt(daysInput.value || "60", 10);
    if (isNaN(days) || days <= 0) {
      showMessage(frequentMessage, "Le nombre de jours doit Ãªtre un entier positif.", "error");
      return;
    }
    try {
      showMessage(frequentMessage, "Chargementâ€¦", "success");
      const res = await fetch(API_BASE + "/reports/frequent-patients?days=" + days);
      if (!res.ok) {
        showMessage(frequentMessage, "Erreur lors du chargement des patients frÃ©quents.", "error");
        return;
      }
      const data = await res.json();
      renderFrequentTable(data);
      showMessage(frequentMessage, "", "success");
    } catch (e) {
      console.error(e);
      showMessage(frequentMessage, "Erreur rÃ©seau lors du chargement.", "error");
    }
  }

  function renderFrequentTable(list) {
    frequentTableBody.innerHTML = "";
    if (!list || !list.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 2;
      td.textContent = "Aucun patient frÃ©quent pour cette pÃ©riode.";
      tr.appendChild(td);
      frequentTableBody.appendChild(tr);
      return;
    }
    list.forEach(p => {
      const pat = p.patientId ? patientsById[p.patientId] : null;
      const name =
        p.patientName ||
        (pat && pat.fullName) ||
        p.fullName ||
        p.name ||
        p.patientId ||
        "â€”";
      const visits = p.visits != null ? p.visits : (p.count != null ? p.count : "â€”");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${name}</td>
        <td>${visits}</td>
      `;
      frequentTableBody.appendChild(tr);
    });
  }

  // Listeners
  loadDayBtn.addEventListener("click", (e) => {
    e.preventDefault();
    loadDayAppointments();
  });

  loadPerDoctorBtn.addEventListener("click", (e) => {
    e.preventDefault();
    loadAppointmentsPerDoctor();
  });

  loadPerSpecialtyBtn.addEventListener("click", (e) => {
    e.preventDefault();
    loadAppointmentsPerSpecialty();
  });

  loadFrequentBtn.addEventListener("click", (e) => {
    e.preventDefault();
    loadFrequentPatients();
  });

  // Initialisation
  (async function init() {
    dayDateInput.value = isoToday();
    await Promise.all([loadPatients(), loadDoctors()]);
    loadDayAppointments();
    loadAppointmentsPerDoctor();
    loadAppointmentsPerSpecialty();
    loadFrequentPatients();
  })();
</script>
</body>
</html>
>
</body>
</html>
